---
title: "Introduction to yersinia: Plague Transmission Modeling in R"
author: "Nicolas Gauthier"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    fig_width: 7
    fig_height: 5
vignette: >
  %\VignetteIndexEntry{Introduction to yersinia}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  warning = FALSE,
  message = FALSE
)
```

# Overview

The `yersinia` package provides a comprehensive toolkit for modeling plague transmission dynamics using stochastic simulation. Built on the robust `odin.dust` framework, it offers realistic population-level models with demographic stochasticity for epidemiological research.

## Key Features

- **Stochastic models**: Realistic demographic noise and individual-based processes
- **Spatial modeling**: Metapopulation dynamics with migration between populations
- **Parameter management**: Literature-based parameter sets with easy customization
- **Human dynamics**: Optional human population compartments
- **Analysis toolkit**: R₀ calculation, outbreak metrics, and visualization

```{r setup}
library(yersinia)
library(dplyr)
library(ggplot2)
library(purrr)

# Set a random seed for reproducible results
set.seed(123)
```

# Getting Started

## Basic Model Run

The simplest way to run a plague model is with the `run_plague_model()` function:

```{r basic-model}
# Run a basic stochastic model, defaults to a single population
results <- run_plague_model(
  n_particles = 50            # Number of stochastic replicates
)

# View the results
results
```

The model returns a `plague_results` object that contains tidy data with standardized column names, along with metadata about the model run.

## Built-in Plotting

All `plague_results` objects have a default plot method that shows uncertainty bands across replicates:

```{r basic-plot, fig.cap="Basic plague model dynamics showing median and 95% confidence intervals"}
plot(results)
```

# Parameter Management

## Parameter Sets

The package includes several parameter sets from the literature:

```{r parameter-sets}
load_parameters("defaults")

# Available parameter sets
param_sets <- c("defaults", "keeling-gilligan", "modern-estimates", "historical")

# Compare R₀ values across parameter sets
tibble(
  name = param_sets,
  parameters = map(name, load_parameters),
  R0 = map_dbl(parameters, calculate_R0)
)
```

## Parameter Customization

Parameters can be easily modified:

```{r custom-parameters}
# Load and examine default parameters
params <- load_parameters("defaults")

# Modify parameters on-the-fly
results_high_transmission <- run_plague_model(
  params = "defaults",
  npop = 1,
  n_particles = 20,
  beta_r = 8.0,     # Higher transmission rate
  g_r = 0.05,       # Higher survival rate
  years = 8
)
```

# Model Types

## Single Population Models

Basic rat-flea dynamics in a single population:

```{r single-population}
# Basic rat-flea model
results_basic <- run_plague_model(
  params = "keeling-gilligan",
  npop = 1,
  n_particles = 30,
  years = 8
)

plot(results_basic, compartments = c("S", "I", "R"))
```

## Human Dynamics

Include human populations in the transmission cycle:

```{r human-model, fig.cap="Plague dynamics including human populations"}
# Model with human dynamics (single population only)
results_humans <- run_plague_model(
  params = "modern-estimates",
  include_humans = TRUE,
  npop = 1,                # Human models require npop = 1
  n_particles = 30,
  years = 10
)

# Plot showing both rat and human compartments
plot(results_humans)
```

## Spatial Models

Multi-population metapopulation dynamics with migration:

```{r spatial-model, fig.cap="Spatial plague dynamics across 25 connected populations"}
# Spatial model with 25 populations (5x5 grid)
results_spatial <- run_plague_model(
  params = "defaults", 
  K_r = 10000,             # Higher total capacity (400 per population)
  npop = 25,               # Creates 5x5 grid automatically
  n_particles = 20,
  years = 5,
  seasonal = FALSE,
  seasonal_amplitue = 1
)


years <- 30
timesteps <- 1:(dt ^ -1 * years)

I_ini = c(10, rep(0, npop - 1)), 
                                 S_ini = 1,
                                 K_r = 10000 / npop,
                                 contact = contact_matrix, #matrix(0,nrow = 16, ncol = 16), # this should cause divide by zero errors!
                                 K_f = 4,
                                 dt = dt,
                                 p = 0.6,
                                 season = seasonal_kf,
                                 # g_r = 1,
                                 npop = npop),
                     time = 1L,
                     n_particles = n_particles,
                     n_threads = 4L,
                     seed = 6L

# Show dynamics for a few populations
plot(results_spatial)
```
```{r}
results_spatial |>
  filter(replicate == 1) |>
  select(-replicate) |>
  tidyr::pivot_wider(names_from = compartment) |>
  ggplot(aes(time, ymax = I)) +
  geom_ribbon(aes(ymin = 0), alpha = 1) +
  facet_wrap(~population) +
  labs(
    title = "Stochastic Simulation of Bubonic Plague Transmission",
    x = "Time (years)",
    y = "Population",
    color = "Compartment"
  ) +
  theme_bw()
```


## Seasonal Forcing

Environmental seasonality affects flea dynamics. The package uses two different approaches for generating seasonal forcing:

```{r seasonal-comparison, fig.cap="Comparison of seasonal forcing approaches"}
# Package approach: matches model timestep
years <- 5
dt_weekly <- 1/52
dt_daily <- 1/365

# Weekly approach (current package - FIXED)
timesteps_weekly <- seq_len(as.integer(dt_weekly^-1 * years))
time_years_weekly <- timesteps_weekly * dt_weekly
seasonal_weekly <- sin(2 * pi * time_years_weekly)

# Daily approach (archive-style, high resolution)
get_season_daily <- function(years = 1) {
  days <- 1:(365 * years)
  season <- (days - 1) %% 365 / 365
  return(season)
}
season_daily <- get_season_daily(years)
seasonal_daily_full <- sin(2 * pi * season_daily)
# Sample at weekly intervals (what archive actually uses)
weekly_indices <- seq(1, length(seasonal_daily_full), by = 7)
seasonal_daily_sampled <- seasonal_daily_full[weekly_indices[1:length(timesteps_weekly)]]

# Create comparison data
comparison_data <- data.frame(
  week = rep(1:length(timesteps_weekly), 2),
  time = rep(time_years_weekly, 2),
  seasonal_value = c(seasonal_weekly, seasonal_daily_sampled),
  approach = rep(c("Package (Weekly)", "Archive (Daily→Weekly)"), each = length(timesteps_weekly))
)

library(ggplot2)
ggplot(comparison_data, aes(time, seasonal_value, color = approach, linetype = approach)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Seasonal Forcing Approaches",
    x = "Time (years)",
    y = "Seasonal Multiplier",
    color = "Method",
    linetype = "Method"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r seasonal-model, fig.cap="Effect of seasonal forcing on plague dynamics"}
# Model with seasonal forcing
results_seasonal <- run_plague_model(
  n_particles = 30,
  seasonal = TRUE,
  years = 15
)

plot(results_seasonal, compartments = c("I", "F"))
```

**Key Differences:**
- **Package approach**: Calculates seasonal values at model timestep resolution
- **Archive approach**: Pre-calculates high-resolution daily seasonal pattern, then samples it at model timesteps  
- **Accuracy**: Daily approach captures sub-weekly seasonal variations more precisely
- **Amplitude**: Both now use the same amplitude system - full ±1.0 sine values with `seasonal_amplitude` parameter controlling the effect in the model

# Analysis Functions

## Basic Reproduction Number (R₀)

The basic reproduction number determines whether an outbreak can occur:

```{r r0-calculation}
# Calculate R₀ for different parameter sets
params_historical <- load_parameters("historical")
R0_historical <- calculate_R0(params_historical)

params_modern <- load_parameters("modern-estimates")  
R0_modern <- calculate_R0(params_modern)

cat("Historical R₀:", round(R0_historical, 2), "\n")
cat("Modern R₀:", round(R0_modern, 2), "\n")

# R₀ > 1 means the disease can spread
if (R0_historical > 1) {
  cat("Historical parameters: Disease can spread\n")
} else {
  cat("Historical parameters: Disease will die out\n")
}
```

## Summary Statistics

Get outbreak summaries from stochastic models:

```{r summary-stats}
# Summary method shows key statistics
summary(results_basic)

# Manual calculation of key metrics
infection_summary <- results_basic |>
  filter(compartment == "I") |>
  group_by(replicate) |>
  summarise(
    peak_infected = max(value),
    total_duration = sum(value > 10) * 0.1,  # time resolution
    .groups = "drop"
  ) |>
  summarise(
    mean_peak = mean(peak_infected),
    median_peak = median(peak_infected),
    mean_duration = mean(total_duration),
    .groups = "drop"
  )

print(infection_summary)
```

# Advanced Analysis

## Parameter Sensitivity

Explore how parameter changes affect outbreak dynamics:

```{r sensitivity}
# Test different transmission rates
beta_values <- c(2, 4, 6, 8)
sensitivity_results <- data.frame()

for (beta in beta_values) {
  result <- run_plague_model(
    params = "defaults",
    npop = 1,
    n_particles = 10,  # Fewer particles for speed
    beta_r = beta,
    years = 5
  )
  
  # Calculate peak infection for each replicate
  peaks <- result |>
    filter(compartment == "I") |>
    group_by(replicate) |>
    summarise(peak = max(value), .groups = "drop") |>
    mutate(beta_r = beta)
  
  sensitivity_results <- bind_rows(sensitivity_results, peaks)
}

# Plot sensitivity
ggplot(sensitivity_results, aes(x = factor(beta_r), y = peak)) +
  geom_boxplot() +
  labs(
    title = "Sensitivity to Transmission Rate",
    x = "Transmission Rate (beta_r)",
    y = "Peak Infected Population"
  ) +
  theme_minimal()
```

## Comparing Model Types

Compare single population vs spatial dynamics:

```{r model-comparison, fig.cap="Comparison of single population vs spatial model dynamics"}
# Single population
single <- run_plague_model(
  params = "defaults",
  npop = 1,
  n_particles = 20,
  years = 5
)

# Spatial model
spatial <- run_plague_model(
  params = "defaults", 
  K_r = 10000,             # Higher total capacity (400 per population)
  npop = 25,
  n_particles = 20,
  years = 5
)

# Compare total infected
single_total <- single |>
  filter(compartment == "I") |>
  group_by(time, replicate) |>
  summarise(total_infected = sum(value), model = "Single", .groups = "drop")

spatial_total <- spatial |>
  filter(compartment == "I") |>
  group_by(time, replicate) |>
  summarise(total_infected = sum(value), model = "Spatial", .groups = "drop")

combined <- bind_rows(single_total, spatial_total)

combined |>
  group_by(time, model) |>
  summarise(
    median = median(total_infected),
    lower = quantile(total_infected, 0.25),
    upper = quantile(total_infected, 0.75),
    .groups = "drop"
  ) |>
  ggplot(aes(time, median, color = model, fill = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
  geom_line() +
  labs(
    title = "Single Population vs Spatial Model",
    x = "Time (years)",
    y = "Total Infected Population",
    color = "Model Type",
    fill = "Model Type"
  ) +
  theme_minimal()
```

# Historical Scenarios

## Black Death Parameters

Model historical plague outbreaks using medieval parameter estimates:

```{r historical-scenario, fig.cap="Modeling plague dynamics with historical parameters"}
# Use historical parameters representing medieval conditions
results_black_death <- run_plague_model(
  params = "historical",
  include_humans = TRUE,
  npop = 1,
  n_particles = 30,
  years = 5
)

# Plot human compartments
results_black_death |>
  filter(compartment %in% c("Sh", "Ih", "Rh")) |>
  group_by(time, compartment) |>
  summarise(
    median = median(value),
    lower = quantile(value, 0.25),
    upper = quantile(value, 0.75),
    .groups = "drop"
  ) |>
  ggplot(aes(time, median, color = compartment, fill = compartment)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
  geom_line() +
  labs(
    title = "Black Death Scenario: Human Population Dynamics",
    subtitle = "Using historical parameter estimates",
    x = "Time (years)",
    y = "Population",
    color = "Compartment"
  ) +
  theme_minimal()
```

## Parameter Set Comparison

Compare outbreak dynamics across different parameter sets:

```{r parameter-comparison, fig.cap="Comparison of plague dynamics across different parameter sets"}
# Run models with different parameter sets
param_sets <- c("historical", "modern-estimates", "defaults")
comparison_data <- data.frame()

for (param_set in param_sets) {
  result <- run_plague_model(
    params = param_set,
    npop = 1,
    n_particles = 20,
    years = 6
  )
  
  summary_data <- result |>
    filter(compartment == "I") |>
    group_by(time) |>
    summarise(
      median = median(value),
      lower = quantile(value, 0.25), 
      upper = quantile(value, 0.75),
      .groups = "drop"
    ) |>
    mutate(parameter_set = param_set)
  
  comparison_data <- bind_rows(comparison_data, summary_data)
}

# Plot comparison
ggplot(comparison_data, aes(time, median, color = parameter_set, fill = parameter_set)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
  geom_line() +
  labs(
    title = "Parameter Set Comparison",
    subtitle = "Infected rat dynamics across different scenarios",
    x = "Time (years)",
    y = "Infected Rats",
    color = "Parameter Set",
    fill = "Parameter Set"
  ) +
  theme_minimal()
```

# Practical Applications

## Intervention Scenarios

Model the effect of different control measures:

```{r interventions, fig.cap="Effect of control interventions on plague dynamics"}
# Compare intervention strategies
interventions <- c("baseline", "rat_control", "flea_control")
intervention_data <- data.frame()

for (intervention in interventions) {
  if (intervention == "baseline") {
    params_list <- list(params = "modern-estimates")
  } else if (intervention == "rat_control") {
    params_list <- list(params = "modern-estimates", K_r = 1500)  # 50% reduction
  } else {
    params_list <- list(params = "modern-estimates", K_f = 3.0)   # Reduced flea capacity
  }
  
  result <- do.call(run_plague_model, c(
    params_list,
    list(npop = 1, n_particles = 20, years = 5)
  ))
  
  summary_data <- result |>
    filter(compartment == "I") |>
    group_by(time) |>
    summarise(
      median = median(value),
      lower = quantile(value, 0.25),
      upper = quantile(value, 0.75),
      .groups = "drop"
    ) |>
    mutate(intervention = intervention)
  
  intervention_data <- bind_rows(intervention_data, summary_data)
}

# Plot comparison
ggplot(intervention_data, aes(time, median, color = intervention, fill = intervention)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
  geom_line() +
  labs(
    title = "Control Intervention Comparison",
    subtitle = "Effect of different control strategies on infected rats",
    x = "Time (years)",
    y = "Infected Rats",
    color = "Intervention",
    fill = "Intervention"
  ) +
  theme_minimal()
```

## Risk Assessment

Assess outbreak risk under different scenarios using R₀:

```{r risk-assessment}
# Calculate R₀ under different scenarios
scenarios_r0 <- data.frame(
  Scenario = c("Baseline", "High Transmission", "Poor Sanitation"),
  R0 = c(
    calculate_R0(load_parameters("modern-estimates")),
    calculate_R0(load_parameters("modern-estimates", beta_r = 7.0)),
    calculate_R0(load_parameters("modern-estimates", K_f = 10.0, K_r = 4000))
  )
)

print(scenarios_r0)

# Visualize risk levels
ggplot(scenarios_r0, aes(x = reorder(Scenario, R0), y = R0)) +
  geom_col(fill = "steelblue", alpha = 0.7) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  coord_flip() +
  labs(
    title = "Outbreak Risk Assessment", 
    subtitle = "R₀ values under different scenarios (red line = epidemic threshold)",
    x = "Scenario",
    y = "Basic Reproduction Number (R₀)"
  ) +
  theme_minimal()
```

# Summary

The `yersinia` package provides a modern toolkit for plague transmission modeling featuring:

- **Stochastic simulation** with demographic noise and realistic population dynamics
- **Spatial modeling** for metapopulation dynamics across connected populations  
- **Evidence-based parameters** from historical and contemporary plague research
- **Human dynamics** integration for epidemiological studies
- **Comprehensive analysis** tools including R₀ calculation and outbreak metrics

The package emphasizes stochastic models that capture biological realism while providing uncertainty quantification essential for epidemiological research and public health applications.

## Getting Help

- **Package documentation**: Use `help(package = "yersinia")` for function references
- **Model details**: See `?run_plague_model` for the main modeling function
- **Parameter information**: Use `print()` on parameter objects to see sources and metadata
- **Deterministic models**: See `vignette("reference-deterministic-models")` for educational examples

## References

1. Keeling, M. J., & Gilligan, C. A. (2000). Metapopulation dynamics of bubonic plague. *Nature*, 407(6806), 903-906.
2. Stenseth, N. C., et al. (2008). Plague: past, present, and future. *PLoS Medicine*, 5(1), e3.
3. Bramanti, B., et al. (2019). Assessing the origins of the European Plagues following the Black Death. *Proceedings of the National Academy of Sciences*, 116(28), 13931-13940.
